<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Mapa Vivo ‚Äî Tour com Controle Bluetooth</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    :root{color-scheme:dark}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#000}
    .hud{position:fixed;top:10px;left:10px;right:10px;display:flex;gap:.5rem;align-items:center;z-index:10}
    .hud.hide{display:none}
    .btn{cursor:pointer;border:0;border-radius:.6rem;padding:.55rem .85rem;background:#2563eb;color:#fff;font-weight:700;box-shadow:0 6px 22px rgba(0,0,0,.25)}
    .btn.secondary{background:#374151}
    .chip{background:rgba(0,0,0,.55);color:#fff;padding:.45rem .7rem;border-radius:.6rem;font-weight:700}
    .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#111827;color:#fff;padding:.55rem .8rem;border-radius:.6rem;opacity:.96;display:none;z-index:10}
  </style>
</head>
<body>
  <!-- HUD -->
  <div class="hud" id="hud">
    <span class="chip" id="poiTitle">Ponto: Orla do Rio</span>
    <button class="btn" id="playPause">‚èØÔ∏è Pausar</button>
    <button class="btn secondary" id="enterVR">üï∂Ô∏è Modo VR</button>
    <button class="btn secondary" id="sensorBtn">üéØ Sensores</button>
  </div>
  <div class="toast" id="toast"></div>

  <!-- Cena -->
  <a-scene vr-mode-ui="enabled:true" renderer="antialias:true; colorManagement:true" device-orientation-permission-ui="enabled:false">
    <!-- Fundo procedural -->
    <a-sky id="sky" color="#0b1020"></a-sky>
    <a-entity light="type: ambient; intensity: 0.4"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="0 4 -2"></a-entity>
    <a-plane color="#1b5e20" rotation="-90 0 0" width="120" height="120" position="0 0 0"></a-plane>

    <!-- Placas/Setas e POIs ser√£o criados via JS em runtime -->
    <a-entity id="sceneRoot"></a-entity>

    <!-- C√¢mera + cursores -->
    <a-entity id="rig" position="0 1.6 0" gamepad-trail="speed: 1.6">
      <a-entity id="camera" camera look-controls wasd-controls="enabled:false"></a-entity>
      <!-- Cursor mouse/touch fora do VR -->
      <a-entity id="cursorMouse" cursor="fuse:false; rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
      <!-- Cursor gaze dentro do VR -->
      <a-entity id="cursorGaze" position="0 0 -1"
        geometry="primitive: ring; radiusInner: 0.007; radiusOuter: 0.012"
        material="color: #00e0b8; shader: flat"
        cursor="fuse:true; fuseTimeout:1000"
        raycaster="objects: .clickable"
        visible="false"></a-entity>
    </a-entity>
  </a-scene>

  <script>
    // ======= Dados da trilha (sem imagens/v√≠deos) =======
    const POIS = [
      { id:'orla',   label:'Orla do Rio',    pos:{x:  0, y:1.6, z:  0}, sky:'#0b1020' },
      { id:'praca',  label:'Pra√ßa Central',  pos:{x:  8, y:1.6, z: -3}, sky:'#102033' },
      { id:'campus', label:'IFTO Campus',    pos:{x: -6, y:1.6, z: -7}, sky:'#0a1a2a' },
      { id:'ponte',  label:'Ponte',          pos:{x:  4, y:1.6, z: -12}, sky:'#08121f' },
      { id:'mercado',label:'Mercado P√∫blico',pos:{x:-10, y:1.6, z: -16}, sky:'#0c1422' },
    ];

    // ======= Utilidades UI =======
    const hud = document.getElementById('hud');
    const toast = document.getElementById('toast');
    const sky = document.getElementById('sky');
    const title = document.getElementById('poiTitle');
    const playPauseBtn = document.getElementById('playPause');
    const scene = document.querySelector('a-scene');
    const rig = document.getElementById('rig');
    const cursorGaze = document.getElementById('cursorGaze');
    let autoplay = true, autoTimer = null, idx = 0;

    function flash(msg, ms=1400){
      toast.textContent = msg; toast.style.display='block';
      clearTimeout(flash._t); flash._t = setTimeout(()=>toast.style.display='none', ms);
    }

    // ======= Constru√ß√£o de placas e setas =======
    const sceneRoot = document.getElementById('sceneRoot');
    function buildPOIs(){
      POIS.forEach((p,i)=>{
        // Poste/placa com o nome do ponto
        const post = document.createElement('a-cylinder');
        post.setAttribute('position', `${p.pos.x} 0 ${p.pos.z}`);
        post.setAttribute('radius', 0.05);
        post.setAttribute('height', 1.4);
        post.setAttribute('color', '#2f3b52');
        sceneRoot.appendChild(post);

        const plate = document.createElement('a-plane');
        plate.setAttribute('position', `${p.pos.x} 1.1 ${p.pos.z}`);
        plate.setAttribute('width', 1.6);
        plate.setAttribute('height', 0.5);
        plate.setAttribute('color', '#0e1a36');
        plate.setAttribute('material', 'opacity:0.9');
        plate.setAttribute('text', `value:${p.label}; color:#bfe4ff; align:center; width:4`);
        sceneRoot.appendChild(plate);

        // Seta ‚Äúpr√≥ximo‚Äù entre os pontos (gaze/click)
        if(i < POIS.length-1){
          const a = document.createElement('a-triangle');
          const mid = midPoint(POIS[i].pos, POIS[i+1].pos);
          a.setAttribute('position', `${mid.x} 1.0 ${mid.z}`);
          a.setAttribute('rotation', `0 ${yawTo(POIS[i].pos, POIS[i+1].pos)} 0`);
          a.setAttribute('scale', '0.6 0.6 0.6');
          a.setAttribute('color', '#00e0b8');
          a.setAttribute('class', 'clickable');
          a.addEventListener('click', nextPOI);
          sceneRoot.appendChild(a);
        }
      });
    }
    function midPoint(a,b){ return { x:(a.x+b.x)/2, y:1.0, z:(a.z+b.z)/2 }; }
    function yawTo(a,b){
      const dx = b.x - a.x, dz = b.z - a.z;
      return (Math.atan2(dx, -dz) * 180/Math.PI).toFixed(2);
    }

    // ======= L√≥gica de tour =======
    function setPOI(i, animate=true){
      idx = (i + POIS.length) % POIS.length;
      const p = POIS[idx];
      title.textContent = 'Ponto: ' + p.label;
      sky.setAttribute('color', p.sky);

      // mover rig suavemente at√© o ponto
      const to = new THREE.Vector3(p.pos.x, p.pos.y, p.pos.z);
      if(animate){
        const from = rig.object3D.position.clone();
        const dur = 450; const t0 = performance.now();
        const step = (t) => {
          const k = Math.min(1, (t - t0) / dur);
          rig.object3D.position.lerpVectors(from, to, k);
          if (k < 1) requestAnimationFrame(step);
        };
        requestAnimationFrame(step);
      } else {
        rig.object3D.position.copy(to);
      }
      flash(`Indo para ${p.label}`);
    }
    function nextPOI(){ setPOI(idx+1); }
    function prevPOI(){ setPOI(idx-1); }

    function startAutoplay(){
      stopAutoplay();
      autoplay = true;
      playPauseBtn.textContent = '‚è∏Ô∏è Pausar';
      autoTimer = setInterval(nextPOI, 4000);
    }
    function stopAutoplay(){
      autoplay = false;
      playPauseBtn.textContent = '‚ñ∂Ô∏è Reproduzir';
      clearInterval(autoTimer); autoTimer = null;
    }

    // ======= HUD bot√µes =======
    document.getElementById('enterVR').addEventListener('click', ()=> scene.enterVR && scene.enterVR());
    playPauseBtn.addEventListener('click', ()=> autoplay ? stopAutoplay() : startAutoplay());
    document.getElementById('sensorBtn').addEventListener('click', async ()=>{
      try{
        const needIOS = typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function';
        if(needIOS){ const res = await DeviceMotionEvent.requestPermission(); flash(res==='granted'?'Sensores ativados':'Permiss√£o negada'); }
        else flash('Sensores prontos');
      }catch{ flash('N√£o foi poss√≠vel ativar sensores'); }
    });

    // ======= VR enter/exit =======
    scene.addEventListener('enter-vr', ()=>{
      hud.classList.add('hide');
      cursorGaze.setAttribute('visible', true);
      screen.orientation && screen.orientation.lock && screen.orientation.lock('landscape').catch(()=>{});
    });
    scene.addEventListener('exit-vr', ()=>{
      hud.classList.remove('hide');
      cursorGaze.setAttribute('visible', false);
    });

    // ======= Gamepad (controle Bluetooth) =======
    AFRAME.registerComponent('gamepad-trail', {
      schema: { speed: {default: 1.6} },
      init(){ this.lastBtn = {}; this.tmp = new THREE.Vector3(); this.vel = new THREE.Vector3(); },
      tick(t, dt){
        const delta = (dt||0)/1000;
        const pads = navigator.getGamepads ? navigator.getGamepads() : [];
        const pad = (pads && pads[0]) || null; if(!pad) return;

        // Eixos
        const ax = (pad.axes[0] || 0), ay = (pad.axes[1] || 0);
        const dead = 0.18;
        const lx = Math.abs(ax) > dead ? ax : 0;
        const ly = Math.abs(ay) > dead ? ay : 0;

        if(lx || ly){
          const cam = document.getElementById('camera');
          const dir = new THREE.Vector3();
          cam.object3D.getWorldDirection(dir); dir.y = 0; dir.normalize();
          const right = new THREE.Vector3().crossVectors(dir, new THREE.Vector3(0,1,0)).multiplyScalar(-1);
          this.tmp.copy(dir).multiplyScalar(-ly).add(right.multiplyScalar(lx)).normalize();
          this.vel.copy(this.tmp).multiplyScalar(this.data.speed * delta);
          this.el.object3D.position.add(this.vel);
        }

        const pressed = i => !!(pad.buttons[i] && pad.buttons[i].pressed);
        const edge = i => { const p = pressed(i); const ch = p && !this.lastBtn[i]; this.lastBtn[i]=p; return ch; };
        if(edge(0)) { stopAutoplay(); nextPOI(); } // A
        if(edge(1)) { stopAutoplay(); prevPOI(); } // B
      }
    });

    // ======= Boot =======
    buildPOIs();
    setPOI(0, false);
    startAutoplay();

    // dica inicial
    flash('Controle conectado? A=Pr√≥ximo, B=Anterior ‚Ä¢ Anal√≥gico: andar');

  </script>
</body>
</html>
