<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Mapa Vivo ‚Äî Trilha na Floresta at√© o Rio</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    :root{color-scheme:dark}
    html, body { height:100%; margin:0; overscroll-behavior: none; }
    body, a-scene { touch-action: none; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#000}
    .hud{position:fixed;top:10px;left:10px;right:10px;display:flex;gap:.5rem;align-items:center;z-index:10}
    .hud.hide{display:none}
    .btn{cursor:pointer;border:0;border-radius:.6rem;padding:.55rem .85rem;background:#2563eb;color:#fff;font-weight:700;box-shadow:0 6px 22px rgba(0,0,0,.25)}
    .btn.secondary{background:#374151}
    .chip{background:rgba(0,0,0,.55);color:#fff;padding:.45rem .7rem;border-radius:.6rem;font-weight:700}
    .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#111827;color:#fff;padding:.55rem .8rem;border-radius:.6rem;opacity:.96;display:none;z-index:10}
    .panel{position:fixed;left:50%;bottom:70px;transform:translateX(-50%);background:rgba(0,0,0,.65);backdrop-filter:blur(6px);color:#e6f3ff;padding:.85rem 1rem;border-radius:.8rem;max-width:92vw;display:none;z-index:10}
    .panel h3{margin:.2rem 0 .3rem;font-size:1rem}
    .panel p{margin:0;color:#c9d9f3;font-size:.95rem}
  </style>
</head>
<body>
  <!-- HUD -->
  <div class="hud" id="hud">
    <span class="chip" id="status">Caminhada: tocando‚Ä¶</span>
    <button class="btn" id="playPause">‚èØÔ∏è Pausar</button>
    <button class="btn secondary" id="enterVR">üï∂Ô∏è Modo VR</button>
    <button class="btn secondary" id="sensorBtn">üéØ Sensores</button>
  </div>
  <div class="toast" id="toast"></div>
  <div class="panel" id="infoPanel"><h3 id="infoTitle">T√≠tulo</h3><p id="infoText">Texto</p></div>

  <!-- Cena -->
  <a-scene vr-mode-ui="enabled:true" renderer="antialias:true; colorManagement:true" device-orientation-permission-ui="enabled:false">
    <!-- Ambiente -->
    <a-sky id="sky" color="#0b1020"></a-sky>
    <a-entity light="type: ambient; intensity: 0.45"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="-2 6 -3"></a-entity>
    <a-plane color="#1b5e20" rotation="-90 0 0" width="300" height="300" position="0 0 0"></a-plane>

    <!-- Raiz do mundo (trilha, √°rvores, marcadores, rio) -->
    <a-entity id="worldRoot"></a-entity>

    <!-- Rig/c√¢mera -->
    <a-entity id="rig" position="0 1.6 0" gamepad-walk="speed: 1.6">
      <a-entity id="camera" camera look-controls wasd-controls="enabled:false"></a-entity>
      <a-entity id="cursorMouse" cursor="fuse:false; rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
      <a-entity id="cursorGaze" position="0 0 -1"
        geometry="primitive: ring; radiusInner: 0.007; radiusOuter: 0.012"
        material="color: #00e0b8; shader: flat"
        cursor="fuse:true; fuseTimeout:1000"
        raycaster="objects: .clickable"
        visible="false"></a-entity>
    </a-entity>
  </a-scene>

  <script>
    // ===== Caminho sinuoso (Catmull-Rom) da vila at√© o rio =====
    const PATH = [
      {x: 0,  z:   0},  // vila (in√≠cio)
      {x: 4,  z:  -2},
      {x: 9,  z:  -6},
      {x: 12, z: -10},
      {x: 10, z: -14},
      {x: 6,  z: -17},
      {x: 2,  z: -20},
      {x:-3,  z: -22},
      {x:-8,  z: -25},
      {x:-12, z: -29}, // margem do rio
    ];

    // Paradas educativas ao longo da trilha (t em 0..1)
    const STOPS = [
      { t: 0.12, title: 'Andiroba (Carapa guianensis)', text: '√Årvore nativa; √≥leo usado em fitoterapia e repelente natural.' },
      { t: 0.28, title: 'A√ßa√≠ (Euterpe oleracea)', text: 'Palmeira de v√°rzea; frutos alimentam e geram renda para comunidades.' },
      { t: 0.47, title: 'Buriti (Mauritia flexuosa)', text: 'Comum em √°reas alagadas; importante para fauna e microclima.' },
      { t: 0.66, title: 'Vit√≥ria-r√©gia (Victoria amazonica)', text: 'Planta aqu√°tica de folhas gigantes; indicador de ambientes alagados.' },
      { t: 0.90, title: 'Peixes do Tocantins', text: 'Tucunar√©, Piau, Pacu e Surubim ‚Äî esp√©cies chave para o equil√≠brio do rio.' }
    ];

    // ===== Utilidades de UI =====
    const hud = document.getElementById('hud');
    const toast = document.getElementById('toast');
    const infoPanel = document.getElementById('infoPanel');
    const infoTitle = document.getElementById('infoTitle');
    const infoText = document.getElementById('infoText');
    const playPauseBtn = document.getElementById('playPause');
    const scene = document.querySelector('a-scene');
    const rig = document.getElementById('rig');
    const camera = document.getElementById('camera');
    const cursorGaze = document.getElementById('cursorGaze');

    function flash(msg, ms=1400){
      toast.textContent = msg; toast.style.display='block';
      clearTimeout(flash._t); flash._t = setTimeout(()=>toast.style.display='none', ms);
    }

    function speak(text){
      try{ const u = new SpeechSynthesisUtterance(text); u.lang='pt-BR'; u.rate=1; u.pitch=1; u.volume=.95; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){}
    }

    function showInfo(title, text){
      infoTitle.textContent = title; infoText.textContent = text;
      infoPanel.style.display = 'block'; speak(`${title}. ${text}`);
    }
    function hideInfo(){ infoPanel.style.display = 'none'; try{ speechSynthesis.cancel(); }catch(e){} }

    // ===== Curva, trilha visual e floresta =====
    const curve = new THREE.CatmullRomCurve3(PATH.map(p=> new THREE.Vector3(p.x, 1.6, p.z)));
    curve.curveType = 'catmullrom'; curve.tension = 0.5;

    const worldRoot = document.getElementById('worldRoot');

    // desenha a "estradinha" com placas ao longo da curva
    function buildPath(){
      const steps = 220; // qualidade do caminho
      const pathWidth = 2.2; // largura do corredor
      for(let i=0;i<steps;i++){
        const t = i/(steps-1);
        const p = curve.getPointAt(t);
        // pequenas placas/segmentos simulando um ch√£o de terra
        const seg = document.createElement('a-plane');
        seg.setAttribute('position', `${p.x} 0.01 ${p.z}`);
        seg.setAttribute('rotation', '-90 0 0');
        seg.setAttribute('width', pathWidth);
        seg.setAttribute('height', 1.4);
        seg.setAttribute('color', '#6b4f2a'); // marrom da trilha
        seg.setAttribute('opacity', '0.92');
        worldRoot.appendChild(seg);
      }
    }

    // √°rvores dos dois lados, evitando o corredor da trilha (largura segura)
    function buildForest(){
      const safeR = 1.6; // raio de seguran√ßa do corredor
      function tooCloseToPath(x,z){
        // aproxima√ß√£o: verifica dist√¢ncia a alguns samples da curva
        for(let s=0; s<=1; s+=0.05){
          const c = curve.getPointAt(s);
          const dx=x-c.x, dz=z-c.z; if((dx*dx+dz*dz) < (safeR*safeR)) return true;
        }
        return false;
      }
      for(let i=0;i<220;i++){
        const x = (Math.random()*60-30); // -30..30
        const z = (Math.random()*-40);   // 0..-40
        if(tooCloseToPath(x,z)) continue;
        const trunkH = 1.2 + Math.random()*1.2;
        const crownR = 0.5 + Math.random()*0.9;
        const trunk = document.createElement('a-cylinder');
        trunk.setAttribute('position', `${x} ${trunkH/2} ${z}`);
        trunk.setAttribute('radius', 0.08);
        trunk.setAttribute('height', trunkH);
        trunk.setAttribute('color', '#6b4f2a');
        worldRoot.appendChild(trunk);
        const crown = document.createElement('a-sphere');
        crown.setAttribute('position', `${x} ${trunkH} ${z}`);
        crown.setAttribute('radius', crownR);
        crown.setAttribute('color', '#1e7b3b');
        crown.setAttribute('material','roughness:1; metalness:0');
        worldRoot.appendChild(crown);
      }
    }

    // rio na √°rea final
    function buildRiver(){
      const end = PATH[PATH.length-1];
      const water = document.createElement('a-plane');
      water.setAttribute('position', `${end.x-4} 0.02 ${end.z-6}`);
      water.setAttribute('rotation', '-90 0 0');
      water.setAttribute('width', 40);
      water.setAttribute('height', 30);
      water.setAttribute('color', '#0b6ea8');
      water.setAttribute('material', 'opacity: 0.92');
      water.setAttribute('animation__wave','property: material.opacity; dir: alternate; from: 0.88; to: 0.96; dur: 1600; loop: true; easing: easeInOutSine');
      worldRoot.appendChild(water);

      // margem com pedras simples
      for(let i=0;i<24;i++){
        const s = 0.2+Math.random()*0.5;
        const dx = (Math.random()*14-7), dz=(Math.random()*4-2);
        const rock = document.createElement('a-icosahedron');
        rock.setAttribute('position', `${end.x-4+dx} 0.1 ${end.z-1+dz}`);
        rock.setAttribute('radius', s);
        rock.setAttribute('color', '#6d6d6d');
        worldRoot.appendChild(rock);
      }
    }

    // marcadores informativos (gaze/click) nas paradas educativas
    function placeMarkers(){
      STOPS.forEach((s, i)=>{
        const v = curve.getPointAt(s.t);
        const marker = document.createElement('a-torus-knot');
        marker.setAttribute('position', `${v.x} 1 ${v.z}`);
        marker.setAttribute('scale', '0.32 0.32 0.32');
        marker.setAttribute('color', i === STOPS.length-1 ? '#00e0ff' : '#00e0b8');
        marker.setAttribute('class', 'clickable');
        marker.setAttribute('animation__rot','property: rotation; to: 0 360 0; loop: true; dur: 3500; easing: linear');
        marker.addEventListener('click', ()=>{ pauseWalk(); showInfo(s.title, s.text); });
        worldRoot.appendChild(marker);

        // placa ao lado
        const plate = document.createElement('a-plane');
        plate.setAttribute('position', `${v.x+0.7} 1 ${v.z+0.6}`);
        plate.setAttribute('width', 1.9); plate.setAttribute('height', 0.65);
        plate.setAttribute('color', '#0e1a36'); plate.setAttribute('material','opacity:0.95');
        plate.setAttribute('text', `value:${s.title}; color:#bfe4ff; align:center; width:4`);
        worldRoot.appendChild(plate);
      });
    }

    // ===== Caminhada autom√°tica =====
    let walking = true; let t = 0; const speed = 0.06; // velocidade do par√¢metro da trilha
    function updateWalk(dt){
      if(!walking) return;
      t += speed * dt; if(t>1){ t = 1; pauseWalk(); flash('Chegamos ao rio!'); showInfo('Peixes do Tocantins', 'Tucunar√©, Piau, Pacu e Surubim ‚Äî cuide do equil√≠brio do ecossistema.'); }
      const pos = curve.getPointAt(t), dir = curve.getTangentAt(Math.max(0,t-0.001));
      rig.object3D.position.copy(pos);
      const look = pos.clone().add(dir); camera.object3D.lookAt(look);

      // abre info automaticamente quando perto de um stop
      for(const s of STOPS){ if(Math.abs(t - s.t) < 0.01){ showInfo(s.title, s.text); } }
    }
    function pauseWalk(){ walking = false; playPauseBtn.textContent = '‚ñ∂Ô∏è Reproduzir'; document.getElementById('status').textContent = 'Caminhada: pausada'; }
    function playWalk(){ walking = true;  playPauseBtn.textContent = '‚è∏Ô∏è Pausar';     document.getElementById('status').textContent = 'Caminhada: tocando‚Ä¶'; hideInfo(); }

    // ===== Loop principal =====
    let last = performance.now();
    function loop(now){ const dt = (now-last)/1000; last = now; updateWalk(dt); requestAnimationFrame(loop); }
    requestAnimationFrame(loop);

    // ===== Constru√ß√£o inicial =====
    buildPath(); buildForest(); buildRiver(); placeMarkers();
    flash('A caminhada vai come√ßar. Olhe os marcadores para saber mais.');

    // ===== HUD bot√µes =====
    document.getElementById('enterVR').addEventListener('click', async ()=>{
      try{
        if(scene?.enterVR) scene.enterVR();
        if(document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
        if(screen.orientation?.lock) await screen.orientation.lock('landscape');
      }catch(e){}
    });
    playPauseBtn.addEventListener('click', ()=> walking ? pauseWalk() : playWalk());
    document.getElementById('sensorBtn').addEventListener('click', async ()=>{
      try{
        const needIOS = typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function';
        if(needIOS){ const res = await DeviceMotionEvent.requestPermission(); flash(res==='granted'?'Sensores ativados':'Permiss√£o negada'); }
        else flash('Sensores prontos');
      }catch{ flash('N√£o foi poss√≠vel ativar sensores'); }
    });

    // ===== VR enter/exit =====
    scene.addEventListener('enter-vr', ()=>{ hud.classList.add('hide'); cursorGaze.setAttribute('visible', true); });
    scene.addEventListener('exit-vr',  ()=>{ hud.classList.remove('hide'); cursorGaze.setAttribute('visible', false); });

    // ===== Gamepad (controle Bluetooth) =====
    // A = avan√ßa trecho | X = volta trecho | Y = play/pause | (B ignorado para n√£o acionar "Voltar" do Android)
    AFRAME.registerComponent('gamepad-walk', {
      schema: { speed: {default: 1.6} },
      init(){ this.lastBtn = {}; this.tmp = new THREE.Vector3(); this.vel = new THREE.Vector3(); },
      tick(ti, dt){
        const delta = (dt||0)/1000; const pads = navigator.getGamepads ? navigator.getGamepads() : []; const pad = (pads && pads[0]) || null; if(!pad) return;
        const ax = (pad.axes[0]||0), ay=(pad.axes[1]||0); const dead=0.18; const lx=Math.abs(ax)>dead?ax:0; const ly=Math.abs(ay)>dead?ay:0;
        if(lx||ly){ const dir = new THREE.Vector3(); camera.object3D.getWorldDirection(dir); dir.y=0; dir.normalize(); const right=new THREE.Vector3().crossVectors(dir,new THREE.Vector3(0,1,0)).multiplyScalar(-1); this.tmp.copy(dir).multiplyScalar(-ly).add(right.multiplyScalar(lx)).normalize(); this.vel.copy(this.tmp).multiplyScalar(this.data.speed*delta); this.el.object3D.position.add(this.vel); }
        const pressed=i=>!!(pad.buttons[i]&&pad.buttons[i].pressed); const edge=i=>{const p=pressed(i); const ch=p&&!this.lastBtn[i]; this.lastBtn[i]=p; return ch;};
        if(edge(0)){ pauseWalk(); t=Math.min(1, t+0.08); flash('Avan√ßo r√°pido'); }
        // if(edge(1)){ ... } // B ignorado
        if(edge(2)){ pauseWalk(); t=Math.max(0, t-0.08); flash('Retrocesso'); }
        if(edge(3)){ walking? pauseWalk(): playWalk(); }
      }
    });

    // ===== Prevenir sair da p√°gina por bot√£o "Voltar" (Android/controle) =====
    history.pushState(null, "", location.href);
    window.addEventListener("popstate", () => { history.pushState(null, "", location.href); });
    const BLOCK_KEYS = new Set(["Backspace","Escape","BrowserBack","GoBack"]);
    ["keydown","keyup"].forEach(type=>{
      window.addEventListener(type, (e)=>{
        if (BLOCK_KEYS.has(e.key) || e.keyCode === 4) { e.preventDefault(); e.stopPropagation(); }
      }, {capture:true});
    });
    window.addEventListener("contextmenu", e=>e.preventDefault());
    window.addEventListener("pointerdown", ()=>{ const sc = document.querySelector('a-scene'); sc && sc.focus && sc.focus(); }, {once:true});
  </script>
</body>
</html>